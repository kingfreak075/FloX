<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParkApp - Configurazione</title>
    <!-- Collega il foglio di stile principale del progetto -->
    <link rel="stylesheet" href="style.css">
    <!-- Material Symbols per la sezione Database -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- File di configurazione DB -->
    <script src="db-config.js"></script>
    <style>
        /* Stili specifici per la pagina di configurazione */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .config-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #4a6fa5;
            position: relative;
        }

        .back-button {
            position: absolute;
            left: 0;
            top: 0;
            background: none;
            border: none;
            color: #4a6fa5;
            cursor: pointer;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .config-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .config-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }

        .config-menu {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            padding: 25px;
        }

        .config-content {
            flex: 2;
            min-width: 300px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            padding: 25px;
            position: relative;
        }

        .menu-title {
            font-size: 1.4rem;
            color: #4a6fa5;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .menu-list {
            list-style: none;
        }

        .menu-item {
            margin-bottom: 12px;
        }

        .menu-item a {
            display: block;
            padding: 14px 18px;
            background-color: #f8f9fa;
            border-left: 4px solid #6c8bc7;
            border-radius: 6px;
            color: #2c3e50;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .menu-item a:hover {
            background-color: #e9ecef;
            border-left-color: #4a6fa5;
            transform: translateX(5px);
        }

        .menu-item a.active {
            background-color: #e3eaf7;
            border-left-color: #2c3e50;
            font-weight: 600;
        }

        .content-title {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .content-placeholder {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }

        .content-placeholder i {
            font-size: 3rem;
            color: #bdc3c7;
            margin-bottom: 20px;
            display: block;
        }

        /* Stili specifici per la sezione Database */
        .db-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .db-header h2 {
            font-size: 1.2rem;
            font-weight: 800;
            margin: 0;
            color: #2c3e50;
        }

        .card-impianto {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }

        .btn-db {
            padding: 12px 20px;
            background-color: #4a6fa5;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .btn-db:hover {
            background-color: #3a5985;
            transform: translateY(-2px);
        }

        .btn-db.secondary {
            background-color: #f1f5f9;
            color: #2c3e50;
            border: 2px solid #cbd5e1;
        }

        .btn-db.danger {
            background-color: #fef2f2;
            color: #991b1b;
            border: 2px solid #fecaca;
        }

        .btn-db.danger:hover {
            background-color: #fee2e2;
        }

        .input-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 800;
            color: #64748b;
            margin-bottom: 6px;
            text-transform: uppercase;
        }

        .input-field {
            width: 100%;
            padding: 12px 15px;
            background: #f8fafc;
            border: 2px solid #cbd5e1;
            border-radius: 10px;
            font-size: 0.9rem;
            outline: none;
            box-sizing: border-box;
            transition: all 0.2s;
        }

        .input-field:focus {
            border-color: #4a6fa5;
            background: white;
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
        }

        .drop-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 10px;
            padding: 25px 15px;
            text-align: center;
            background: #f8fafc;
            transition: all 0.2s;
            cursor: pointer;
        }

        .drop-zone:hover {
            border-color: #4a6fa5;
            background: #eff6ff;
        }

        .message {
            display: none;
            margin-top: 1rem;
            padding: 12px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .message.success {
            background-color: #f0fdf4;
            color: #166534;
            border-left: 4px solid #22c55e;
        }

        .message.error {
            background-color: #fef2f2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .message.info {
            background-color: #eff6ff;
            color: #1e40af;
            border-left: 4px solid #4a6fa5;
        }

        .config-info {
            margin-top: 1.5rem;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #cbd5e1;
        }

        .file-info {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: #f0fdf4;
            border-radius: 8px;
            border-left: 4px solid #22c55e;
        }

        /* Info profilo stile */
        .profile-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }

        .info-card h3 {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 10px;
            text-transform: uppercase;
            font-weight: 700;
        }

        .info-card p {
            font-size: 1rem;
            color: #1e293b;
            font-weight: 600;
            word-break: break-all;
        }

        .localstorage-info {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .localstorage-info h3 {
            color: #92400e;
            margin-bottom: 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .config-container {
                flex-direction: column;
            }
            
            .db-buttons {
                flex-direction: column;
            }
        }

        /* Footer/pulsanti */
        .config-footer {
            margin-top: 30px;
            text-align: right;
        }

        .btn {
            padding: 10px 20px;
            background-color: #4a6fa5;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #3a5985;
        }

        /* Animazione */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Intestazione pagina -->
    <header class="config-header">
        <button class="back-button" onclick="window.location.href='menu.html'">
            <span class="material-symbols-rounded">arrow_back</span>
            Torna al Menu
        </button>
        <h1>‚öôÔ∏è Configurazione ParkApp</h1>
        <p>Gestisci le impostazioni dell'applicazione e del database</p>
    </header>

    <!-- Container principale con menu e contenuto -->
    <div class="config-container">
        <!-- Menu laterale di navigazione -->
        <nav class="config-menu">
            <h2 class="menu-title">Menu Configurazione</h2>
            <ul class="menu-list">
                <li class="menu-item"><a href="#" class="active" onclick="loadSection('profilo')">üë§ Profilo Utente</a></li>
                <li class="menu-item"><a href="#" onclick="loadSection('database')">üóÑÔ∏è Database</a></li>
            </ul>
        </nav>

        <!-- Area di contenuto dinamico -->
        <main class="config-content" id="main-content">
            <!-- Contenuto iniziale (Profilo Utente) -->
            <div id="profilo-section">
                <h2 class="content-title">Profilo Utente & Informazioni App</h2>
                <div class="profile-info-grid">
                    <div class="info-card">
                        <h3>Database Configurato</h3>
                        <p id="db-status">Verificando...</p>
                    </div>
                    <div class="info-card">
                        <h3>Ultima Configurazione DB</h3>
                        <p id="db-timestamp">-</p>
                    </div>
                    <div class="info-card">
                        <h3>URL Database</h3>
                        <p id="db-url">-</p>
                    </div>
                    <div class="info-card">
                        <h3>Chiave Presente</h3>
                        <p id="db-key-status">-</p>
                    </div>
                </div>

                <!-- Informazioni localStorage -->
                <div class="localstorage-info" id="localstorage-info">
                    <h3>üìä Informazioni localStorage</h3>
                    <div id="storage-items"></div>
                </div>

                <!-- Pulsante reset -->
                <div style="margin-top: 30px;">
                    <button class="btn-db danger" onclick="resetAppData()" style="width: 100%;">
                        <span class="material-symbols-rounded">delete</span>
                        Reset Tutti i Dati App
                    </button>
                    <p style="font-size: 0.8rem; color: #64748b; margin-top: 10px;">
                        Attenzione: Verranno cancellati tutti i dati locali dell'applicazione
                    </p>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript per la gestione della pagina -->
    <script>
        // VARIABILI GLOBALI PER DB
        let supabaseClient = null;
        let fileCaricato = null;

        // Funzione per caricare diverse sezioni nel contenuto
        function loadSection(section) {
            const mainContent = document.getElementById('main-content');
            
            // Rimuovi la classe 'active' da tutti i menu item
            document.querySelectorAll('.menu-item a').forEach(item => {
                item.classList.remove('active');
            });
            
            // Aggiungi la classe 'active' all'elemento cliccato
            event.target.classList.add('active');
            
            // Cambia contenuto in base alla sezione selezionata
            switch(section) {
                case 'profilo':
                    mainContent.innerHTML = `
                        <h2 class="content-title">Profilo Utente & Informazioni App</h2>
                        <div class="profile-info-grid">
                            <div class="info-card">
                                <h3>Database Configurato</h3>
                                <p id="db-status">Verificando...</p>
                            </div>
                            <div class="info-card">
                                <h3>Ultima Configurazione DB</h3>
                                <p id="db-timestamp">-</p>
                            </div>
                            <div class="info-card">
                                <h3>URL Database</h3>
                                <p id="db-url">-</p>
                            </div>
                            <div class="info-card">
                                <h3>Chiave Presente</h3>
                                <p id="db-key-status">-</p>
                            </div>
                        </div>

                        <!-- Informazioni localStorage -->
                        <div class="localstorage-info" id="localstorage-info">
                            <h3>üìä Informazioni localStorage</h3>
                            <div id="storage-items"></div>
                        </div>

                        <!-- Pulsante reset -->
                        <div style="margin-top: 30px;">
                            <button class="btn-db danger" onclick="resetAppData()" style="width: 100%;">
                                <span class="material-symbols-rounded">delete</span>
                                Reset Tutti i Dati App
                            </button>
                            <p style="font-size: 0.8rem; color: #64748b; margin-top: 10px;">
                                Attenzione: Verranno cancellati tutti i dati locali dell'applicazione
                            </p>
                        </div>
                    `;
                    
                    // Carica le informazioni del profilo
                    setTimeout(loadProfileInfo, 100);
                    break;
                    
                case 'database':
                    mainContent.innerHTML = `
                        <!-- Header con pulsante Torna -->
                        <div class="db-header">
                            <button onclick="loadSection('profilo')" style="background: none; border: none; cursor: pointer; display: flex; align-items: center;">
                                <span class="material-symbols-rounded" style="color: #4a6fa5;">arrow_back</span>
                            </button>
                            <div>
                                <h2>üîå Configurazione Database</h2>
                                <div id="stato-connessione" style="font-size: 0.75rem; color: #64748b; font-weight: 600;">
                                    ${hasDbConfig() ? 'Configurato' : 'Non configurato'}
                                </div>
                            </div>
                        </div>

                        <!-- SEZIONE 1: METODI DI CARICAMENTO -->
                        <div class="card-impianto" style="margin-bottom: 1.5rem; flex-direction: column; align-items: flex-start;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                <span class="material-symbols-rounded" style="color: #4a6fa5; font-size: 1.5rem;">database</span>
                                <h2 style="font-size: 1rem; font-weight: 800; margin: 0; color: #2c3e50;">
                                    Carica Configurazione
                                </h2>
                            </div>

                            <!-- OPZIONE 1: Carica file DB.kf -->
                            <div style="width: 100%; margin-bottom: 20px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <span class="material-symbols-rounded" style="color: #22c55e;">upload_file</span>
                                    <span style="font-weight: 700; color: #2c3e50;">Carica file DB.kf</span>
                                </div>
                                
                                <div style="position: relative; width: 100%;">
                                    <input type="file" id="file-kf" accept=".kf,.txt,.json" 
                                           style="position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2;">
                                    <div class="drop-zone" id="drop-zone">
                                        <span class="material-symbols-rounded" style="font-size: 2.5rem; color: #4a6fa5; opacity: 0.7; margin-bottom: 10px;">
                                            cloud_upload
                                        </span>
                                        <div style="font-weight: 700; color: #2c3e50; margin-bottom: 5px;">
                                            Trascina il file DB.kf qui
                                        </div>
                                        <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 15px;">
                                            Oppure clicca per selezionare
                                        </div>
                                        <div style="font-size: 0.7rem; color: #4a6fa5; background: #eff6ff; padding: 5px 10px; border-radius: 6px; display: inline-block;">
                                            Formati supportati: .kf, .txt, .json
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="file-info" class="file-info">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <div>
                                            <div style="font-weight: 700; color: #166534;">File caricato</div>
                                            <div style="font-size: 0.8rem; color: #15803d;" id="file-name"></div>
                                        </div>
                                        <button onclick="rimuoviFile()" style="background: none; border: none; color: #ef4444; cursor: pointer;">
                                            <span class="material-symbols-rounded">close</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- SEPARATORE "OPPURE" -->
                            <div style="display: flex; align-items: center; width: 100%; margin: 20px 0;">
                                <div style="flex: 1; height: 1px; background: #cbd5e1;"></div>
                                <div style="padding: 0 15px; font-size: 0.8rem; font-weight: 700; color: #64748b;">OPPURE</div>
                                <div style="flex: 1; height: 1px; background: #cbd5e1;"></div>
                            </div>

                            <!-- OPZIONE 2: Inserimento manuale -->
                            <div style="width: 100%;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <span class="material-symbols-rounded" style="color: #3b82f6;">keyboard</span>
                                    <span style="font-weight: 700; color: #2c3e50;">Inserimento manuale</span>
                                </div>

                                <!-- Input URL -->
                                <div style="width: 100%; margin-bottom: 15px;">
                                    <label class="input-label">SUPABASE URL</label>
                                    <input type="text" id="supabase-url" placeholder="https://tuoprogetto.supabase.co" class="input-field">
                                    <div style="font-size: 0.7rem; color: #64748b; margin-top: 4px;">
                                        Dashboard ‚Üí Settings ‚Üí API
                                    </div>
                                </div>

                                <!-- Input Key -->
                                <div style="width: 100%; margin-bottom: 20px;">
                                    <label class="input-label">ANON KEY</label>
                                    <div style="position: relative;">
                                        <input type="password" id="supabase-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." class="input-field" style="padding-right: 45px;">
                                        <button id="toggle-key" onclick="togglePassword()" type="button"
                                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #64748b; cursor: pointer;">
                                            <span class="material-symbols-rounded" style="font-size: 20px;">visibility</span>
                                        </button>
                                    </div>
                                    <div style="font-size: 0.7rem; color: #64748b; margin-top: 4px;">
                                        Chiave anonima (pubblica) del progetto
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- PULSANTI AZIONE -->
                        <div style="display: flex; gap: 10px; margin-bottom: 1.5rem; flex-wrap: wrap;">
                            <button id="btn-test" onclick="testConnessione()" class="btn-db" style="flex: 2; min-width: 200px;">
                                <span id="icon-test" class="material-symbols-rounded">wifi</span>
                                <span id="text-test">Test Connessione</span>
                            </button>
                            
                            <button id="btn-export" onclick="esportaConfigurazione()" class="btn-db secondary" style="flex: 1; min-width: 120px;">
                                <span class="material-symbols-rounded">download</span>
                                <span>Export</span>
                            </button>
                            
                            <button id="btn-reset" onclick="resetConfigurazione()" class="btn-db danger" style="flex: 1; min-width: 120px;">
                                <span class="material-symbols-rounded">delete</span>
                                <span>Reset</span>
                            </button>
                        </div>

                        <!-- MESSAGGIO STATO -->
                        <div id="messaggio-stato" class="message"></div>
                        
                        <!-- INFO CONFIGURAZIONE ATTUALE -->
                        <div id="config-info" class="config-info" style="${hasDbConfig() ? 'display: block;' : 'display: none;'}">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <span class="material-symbols-rounded" style="color: #22c55e;">check_circle</span>
                                <h3 style="font-size: 0.9rem; font-weight: 800; margin: 0; color: #2c3e50;">
                                    Configurazione Attuale
                                </h3>
                            </div>
                            <div style="font-size: 0.8rem; color: #64748b; line-height: 1.4;">
                                <div><strong>URL:</strong> <span id="current-url">-</span></div>
                                <div><strong>Ultimo test:</strong> <span id="current-test">-</span></div>
                                <div><strong>Stato:</strong> <span id="current-status" style="color: #22c55e; font-weight: 700;">Operativo</span></div>
                            </div>
                        </div>
                    `;
                    
                    // Inizializza la sezione Database
                    setTimeout(() => {
                        initDBSection();
                    }, 10);
                    break;
            }
        }

        // CARICA INFORMAZIONI PROFILO E localStorage
        function loadProfileInfo() {
            try {
                // Informazioni Database
                const dbInfo = getDbConfigInfo();
                
                document.getElementById('db-status').textContent = dbInfo.configured ? 
                    '‚úÖ Configurato' : '‚ùå Non configurato';
                document.getElementById('db-status').style.color = dbInfo.configured ? '#22c55e' : '#ef4444';
                
                document.getElementById('db-timestamp').textContent = dbInfo.timestamp || 'Mai configurato';
                document.getElementById('db-url').textContent = dbInfo.urlShort || 'Non configurato';
                document.getElementById('db-key-status').textContent = dbInfo.keyPresent ? 
                    `‚úÖ Presente (${dbInfo.keyLength} caratteri)` : '‚ùå Assente';

                // Mostra tutte le chiavi localStorage
                const storageItemsDiv = document.getElementById('storage-items');
                const items = [];
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    let value = localStorage.getItem(key);
                    
                    // Formatta il valore
                    let displayValue = value;
                    if (key.includes('key') || key.includes('token') || key.includes('password')) {
                        displayValue = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                    } else if (value && value.length > 50) {
                        displayValue = value.substring(0, 50) + '...';
                    }
                    
                    items.push(`
                        <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="font-weight: 700; color: #1e293b; font-size: 0.9rem;">${key}</div>
                            <div style="font-size: 0.8rem; color: #64748b; word-break: break-all;">${displayValue}</div>
                            <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 5px;">
                                Lunghezza: ${value.length} caratteri
                            </div>
                        </div>
                    `);
                }
                
                storageItemsDiv.innerHTML = items.length ? 
                    items.join('') : 
                    '<p style="color: #64748b; font-style: italic;">Nessun dato salvato nel localStorage</p>';
                    
                document.getElementById('localstorage-info').innerHTML += `
                    <div style="font-size: 0.8rem; color: #92400e; margin-top: 10px; padding: 10px; background: #fffbeb; border-radius: 6px;">
                        <strong>Totale elementi:</strong> ${localStorage.length}
                    </div>
                `;
                
            } catch (error) {
                console.error('Errore caricamento info:', error);
                document.getElementById('db-status').textContent = 'Errore caricamento';
                document.getElementById('db-status').style.color = '#ef4444';
            }
        }

        // RESET TUTTI I DATI APP
        function resetAppData() {
            if (!confirm('‚ö†Ô∏è ATTENZIONE!\n\nStai per cancellare TUTTI i dati locali dell\'applicazione, inclusi:\n‚Ä¢ Configurazione database\n‚Ä¢ Credenziali\n‚Ä¢ Dati utente\n‚Ä¢ Impostazioni\n\nSei sicuro di voler procedere?')) {
                return;
            }
            
            try {
                // Cancella tutto il localStorage
                localStorage.clear();
                
                // Mostra messaggio
                alert('‚úÖ Tutti i dati locali sono stati cancellati.\nL\'applicazione verr√† ricaricata.');
                
                // Ricarica la pagina
                setTimeout(() => {
                    location.reload();
                }, 1000);
                
            } catch (error) {
                alert('‚ùå Errore durante il reset: ' + error.message);
            }
        }

        // INIZIALIZZAZIONE SEZIONE DATABASE
        function initDBSection() {
            // Carica configurazione salvata e mostra info
            mostraInfoConfigurazione();
            
            // Setup drag & drop
            setupDragAndDrop();
            
            // Setup file input
            const fileInput = document.getElementById('file-kf');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
        }

        // FUNZIONE: Mostra info configurazione corrente
        function mostraInfoConfigurazione() {
            if (hasDbConfig()) {
                const info = getDbConfigInfo();
                const configInfo = document.getElementById('config-info');
                const statoConnessione = document.getElementById('stato-connessione');
                
                if (configInfo) {
                    configInfo.style.display = 'block';
                    document.getElementById('current-url').textContent = info.urlShort || '-';
                    document.getElementById('current-test').textContent = info.timestamp || '-';
                    document.getElementById('current-status').textContent = 'Configurato';
                    document.getElementById('current-status').style.color = '#22c55e';
                }
                
                if (statoConnessione) {
                    statoConnessione.innerHTML = `
                        <span style="color: #22c55e; font-weight: 800;">Configurato</span> ‚Ä¢ ${info.urlShort || 'N/A'}
                    `;
                }
                
                // Popola campi manuali
                const urlInput = document.getElementById('supabase-url');
                const keyInput = document.getElementById('supabase-key');
                
                if (urlInput) urlInput.value = info.url || '';
                if (keyInput) keyInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            }
        }

        // FUNZIONE: Setup drag & drop
        function setupDragAndDrop() {
            const dropZone = document.getElementById('drop-zone');
            if (!dropZone) return;
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#4a6fa5';
                dropZone.style.backgroundColor = '#eff6ff';
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#cbd5e1';
                dropZone.style.backgroundColor = '#f8fafc';
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#cbd5e1';
                dropZone.style.backgroundColor = '#f8fafc';
                
                if (e.dataTransfer.files.length) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
        }

        // FUNZIONE: Gestione selezione file
        function handleFileSelect(event) {
            if (event.target.files.length) {
                handleFile(event.target.files[0]);
            }
        }

        // FUNZIONE: Processa file
        function handleFile(file) {
            if (!file.name.match(/\.(kf|txt|json)$/i)) {
                mostraMessaggio('Formato file non supportato. Usa .kf, .txt o .json', 'errore');
                return;
            }
            
            if (file.size > 1024 * 10) {
                mostraMessaggio('File troppo grande (max 10KB)', 'errore');
                return;
            }
            
            fileCaricato = file;
            
            document.getElementById('file-info').style.display = 'block';
            document.getElementById('file-name').textContent = file.name;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const success = importDbConfig(e.target.result);
                    if (success) {
                        mostraMessaggio(`‚úÖ Configurazione caricata da ${file.name}`, 'successo');
                        // Popola campi manuali
                        const info = getDbConfigInfo();
                        document.getElementById('supabase-url').value = info.url;
                        document.getElementById('supabase-key').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                        // Aggiorna info
                        mostraInfoConfigurazione();
                    }
                } catch (error) {
                    mostraMessaggio(`Errore: ${error.message}`, 'errore');
                    rimuoviFile();
                }
            };
            reader.readAsText(file);
        }

        // FUNZIONE: Rimuovi file caricato
        function rimuoviFile() {
            fileCaricato = null;
            document.getElementById('file-info').style.display = 'none';
            document.getElementById('file-kf').value = '';
        }

        // FUNZIONE: Mostra/nascondi password
        function togglePassword() {
            const input = document.getElementById('supabase-key');
            const toggleBtn = document.getElementById('toggle-key');
            
            if (!input || !toggleBtn) return;
            
            if (input.type === 'password') {
                input.type = 'text';
                toggleBtn.innerHTML = '<span class="material-symbols-rounded" style="font-size:20px;">visibility_off</span>';
                
                // Se il campo mostra placeholder, reimposta a vuoto quando si mostra
                if (input.value === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                    const actualKey = getSupabaseKey();
                    if (actualKey) {
                        input.value = actualKey;
                    }
                }
            } else {
                input.type = 'password';
                toggleBtn.innerHTML = '<span class="material-symbols-rounded" style="font-size:20px;">visibility</span>';
                
                // Nascondi la chiave reale
                if (input.value !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                    input.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                }
            }
        }

        // FUNZIONE: Test connessione Supabase
        async function testConnessione() {
            const url = document.getElementById('supabase-url').value.trim();
            const keyInput = document.getElementById('supabase-key');
            
            // Gestione speciale per campo password "nascosto"
            let key = keyInput.value;
            if (key === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                // Usa la chiave salvata
                key = getSupabaseKey();
                if (!key) {
                    mostraMessaggio('Inserisci la chiave Supabase', 'errore');
                    return;
                }
            } else {
                key = key.trim();
            }
            
            // Validazione input
            if (!url || !key) {
                mostraMessaggio('Inserisci URL e Anon Key', 'errore');
                return;
            }
            
            if (!url.startsWith('https://')) {
                mostraMessaggio('URL deve iniziare con https://', 'errore');
                return;
            }
            
            // Aggiorna UI pulsante
            const btnTest = document.getElementById('btn-test');
            const iconTest = document.getElementById('icon-test');
            const textTest = document.getElementById('text-test');
            
            btnTest.disabled = true;
            btnTest.style.backgroundColor = '#94a3b8';
            iconTest.textContent = 'sync';
            iconTest.style.animation = 'spin 1s linear infinite';
            textTest.textContent = 'Connessione in corso...';
            
            try {
                // SALVA CONFIGURAZIONE PRIMA DEL TEST
                saveDbConfig(url, key);
                
                // TEST CONNESIONE
                const testResult = await testDbConnection();
                
                if (testResult.success) {
                    // Successo
                    mostraMessaggio(`‚úÖ ${testResult.message}`, 'successo');
                    document.getElementById('stato-connessione').innerHTML = `
                        <span style="color: #22c55e; font-weight: 800;">Connesso</span> ‚Ä¢ ${url.replace('https://', '').substring(0, 20)}...
                    `;
                    
                    // Aggiorna info
                    document.getElementById('current-test').textContent = new Date().toLocaleString('it-IT');
                    document.getElementById('current-status').textContent = 'Operativo';
                    document.getElementById('current-status').style.color = '#22c55e';
                    
                } else {
                    throw new Error(testResult.error || 'Connessione fallita');
                }
                
            } catch (error) {
                console.error('Errore connessione:', error);
                
                let messaggio = 'Errore di connessione';
                if (error.message.includes('JWT') || error.message.includes('token')) {
                    messaggio = 'Anon Key non valida o scaduta';
                } else if (error.message.includes('fetch') || error.message.includes('network')) {
                    messaggio = 'URL non raggiungibile o errato';
                } else if (error.code === '42501') {
                    messaggio = 'Permessi insufficienti';
                } else {
                    messaggio = error.message.substring(0, 100);
                }
                
                mostraMessaggio(`‚ùå ${messaggio}`, 'errore');
                document.getElementById('stato-connessione').innerHTML = `
                    <span style="color: #ef4444; font-weight: 800;">Errore di connessione</span>
                `;
                
                // Aggiorna stato in info
                const currentStatus = document.getElementById('current-status');
                if (currentStatus) {
                    currentStatus.textContent = 'Errore';
                    currentStatus.style.color = '#ef4444';
                }
                
            } finally {
                btnTest.disabled = false;
                btnTest.style.backgroundColor = '#4a6fa5';
                iconTest.textContent = 'wifi';
                iconTest.style.animation = 'none';
                textTest.textContent = 'Test Connessione';
            }
        }

        // FUNZIONE: Esporta configurazione corrente
        function esportaConfigurazione() {
            if (!hasDbConfig()) {
                mostraMessaggio('Configura prima URL e Key', 'errore');
                return;
            }
            
            try {
                const contenuto = exportDbConfig();
                
                // Crea blob e scarica
                const blob = new Blob([contenuto], { type: 'text/plain' });
                const urlBlob = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = urlBlob;
                a.download = 'PArkApp_DB_Config.kf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(urlBlob);
                
                mostraMessaggio('‚úÖ Configurazione esportata come ParkApp_DB_Config.kf', 'successo');
                
            } catch (error) {
                mostraMessaggio(`Errore esportazione: ${error.message}`, 'errore');
            }
        }

        // FUNZIONE: Reset configurazione DB
        function resetConfigurazione() {
            if (!confirm('Sei sicuro di voler resettare la configurazione del database?\nTutti i dati di connessione verranno cancellati.')) {
                return;
            }
            
            try {
                // Cancella solo i dati di configurazione DB dal localStorage
                localStorage.removeItem('flox_db_url');
                localStorage.removeItem('flox_db_key');
                localStorage.removeItem('flox_db_timestamp');
                
                // Resetta variabili
                supabaseClient = null;
                fileCaricato = null;
                
                // Aggiorna UI
                mostraMessaggio('‚úÖ Configurazione database resettata', 'successo');
                
                // Nascondi info configurazione
                const configInfo = document.getElementById('config-info');
                if (configInfo) configInfo.style.display = 'none';
                
                // Aggiorna stato
                const statoConnessione = document.getElementById('stato-connessione');
                if (statoConnessione) statoConnessione.textContent = 'Non configurato';
                
                // Resetta campi input
                const urlInput = document.getElementById('supabase-url');
                const keyInput = document.getElementById('supabase-key');
                
                if (urlInput) urlInput.value = '';
                if (keyInput) {
                    keyInput.value = '';
                    keyInput.type = 'password';
                    const toggleBtn = document.getElementById('toggle-key');
                    if (toggleBtn) {
                        toggleBtn.innerHTML = '<span class="material-symbols-rounded" style="font-size:20px;">visibility</span>';
                    }
                }
                
                // Rimuovi file se presente
                rimuoviFile();
                
            } catch (error) {
                mostraMessaggio(`Errore reset: ${error.message}`, 'errore');
            }
        }

        // FUNZIONE: Mostra messaggi
        function mostraMessaggio(testo, tipo = 'info') {
            const messaggioDiv = document.getElementById('messaggio-stato');
            if (!messaggioDiv) return;
            
            messaggioDiv.textContent = testo;
            messaggioDiv.className = 'message';
            messaggioDiv.classList.add(tipo);
            messaggioDiv.style.display = 'block';
            
            setTimeout(() => {
                messaggioDiv.style.display = 'none';
            }, 5000);
        }

        // Inizializza la pagina
        document.addEventListener('DOMContentLoaded', function() {
            // Carica le informazioni del profilo all'avvio
            loadProfileInfo();
        });
    </script>
</body>
</html>