<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Presenze PRO - Color Coding</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        .row-hover:hover { filter: brightness(0.92); cursor: pointer; }
        .bg-sabato { background-color: rgba(255, 165, 0, 0.12); }
        .bg-domenica { background-color: rgba(255, 0, 0, 0.12); }
        .bg-festivo { background-color: rgba(255, 0, 0, 0.12); }
        .text-anomaly { color: #dc2626; font-weight: 800; }
        .text-ok { color: #16a34a; font-weight: 600; }
        table { border-spacing: 0; border-collapse: collapse; table-layout: fixed; width: 100%; }
        td, th { border: 1px solid #e2e8f0; padding: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .col-data { width: 110px; }
        .col-giorno { width: 90px; }
        .col-ore { width: 65px; } 
        .btn-ctrl { transition: all 0.2s; border: 1px solid #e2e8f0; background: white; }
        .btn-ctrl:hover { background-color: #f8fafc; transform: translateY(-1px); }
        .btn-active { background-color: #f1f5f9; border-color: #3b82f6; box-shadow: 0 0 8px rgba(59, 130, 246, 0.3); }
        
        #modal { backdrop-filter: blur(4px); transition: all 0.3s; }
        .modal-content { animation: slideDown 0.3s ease-out; }
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .timeline-line { width: 2px; background: #e2e8f0; position: absolute; left: 19px; top: 30px; bottom: -10px; }
    @media print {
    /* Nasconde tutto ci√≤ che non serve nel PDF */
    #upload, .btn-ctrl, #filter-bar select, #btnExport, #btnPDF {
        display: none !important;
    }
    /* Ottimizza i colori per la stampa */
    body { background-color: white !important; p: 0; }
    .max-w-7xl { shadow: none !important; border: none !important; width: 100% !important; max-width: 100% !important; }
    /* Evita che le righe vengano tagliate a met√† tra due pagine */
    tr { page-break-inside: avoid; }
}
    
    
    
    </style>
</head>
<body class="bg-slate-100 p-4 min-h-screen font-sans text-slate-900">

    <div class="max-w-7xl mx-auto bg-white shadow-2xl rounded-2xl overflow-hidden border border-slate-200">
        
        <div class="p-6 border-b bg-white flex flex-col lg:flex-row justify-between items-start gap-6">
            <div class="flex flex-col gap-4 w-full lg:w-1/3">
                <div>
                    <h1 class="text-2xl font-black text-slate-800 uppercase tracking-tighter italic">Monitor Presenze</h1>
                    <input type="file" id="upload" class="mt-2 text-xs border p-2 rounded-lg bg-slate-50 w-full" accept=".xlsx" />
                </div>
                
                <div id="filter-bar" class="hidden flex flex-col gap-3">
                    <div class="flex flex-wrap gap-2">
                        <select id="selectMese" class="p-2 rounded-lg border border-slate-300 text-sm flex-1 bg-white shadow-sm">
                            <option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option>
                            <option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option>
                            <option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option>
                            <option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option>
                        </select>
                        <select id="selectAnno" class="p-2 rounded-lg border border-slate-300 text-sm w-24 bg-white shadow-sm">
                            <option value="2025">2025</option><option value="2026">2026</option>
                        </select>
                    </div>
                    <select id="selectTecnico" class="p-2 rounded-lg border border-slate-300 text-sm font-bold w-full bg-white shadow-sm"></select>
                    
                    <div class="flex gap-2">
                        <button id="btnPlay" onclick="toggleSlideshow(3000, 'btnPlay')" class="btn-ctrl flex-1 py-2 rounded-lg text-lg shadow-sm">‚ñ∂Ô∏è</button>
                        <button id="btnFast" onclick="toggleSlideshow(1000, 'btnFast')" class="btn-ctrl flex-1 py-2 rounded-lg text-lg shadow-sm">‚è©</button>
                        <button id="btnPause" onclick="pauseSlideshow()" class="btn-ctrl flex-1 py-2 rounded-lg text-lg shadow-sm">‚è∏Ô∏è</button>
                        <button id="btnStop" onclick="stopSlideshow()" class="btn-ctrl flex-1 py-2 rounded-lg text-lg shadow-sm">‚èπÔ∏è</button>
                    </div>
                </div><button id="btnExport" onclick="exportToExcel()" title="Esporta in Excel" class="btn-ctrl px-4 py-2 rounded-lg text-lg shadow-sm bg-emerald-50 border-emerald-200 hover:bg-emerald-100">
    üì• Esporta
</button>
<button id="btnPDF" onclick="generaPDF()" class="btn-ctrl px-4 py-2 rounded-lg text-lg shadow-sm bg-red-50 border-red-200 hover:bg-red-100 font-bold text-red-700">
    PDF PRO
</button>
            </div>

            <div id="stats-panel" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4 bg-slate-50 p-5 rounded-2xl border border-slate-200 w-full lg:w-2/3 shadow-inner">
                <div class="text-center border-r border-slate-200">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Lavorate</p>
                    <p id="sumOrd" class="text-2xl font-black text-slate-700">0,00</p>
                </div>
                <div class="text-center border-r border-slate-200">
                    <p class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">Assenze</p>
                    <p id="sumAss" class="text-2xl font-black text-blue-600">0,00</p>
                </div>
                <div class="text-center border-r border-slate-200">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Straord.</p>
                    <p id="sumStra" class="text-2xl font-black text-slate-700">0,00</p>
                </div>
                <div class="text-center">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Viaggio</p>
                    <p id="sumVgg" class="text-2xl font-black text-slate-700">0,00</p>
                </div>
                <div class="col-span-full border-t border-slate-200 pt-3 mt-1 flex justify-between items-center px-2">
                    <div id="decadeStatus" class="text-xl flex gap-3 tracking-tighter"></div>
                    <div class="bg-white px-3 py-1 rounded-full border shadow-sm">
                        <span class="text-[10px] font-bold text-slate-400 uppercase mr-2">Target Mese:</span>
                        <span id="totalRatio" class="text-sm font-black italic">-- / --</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="bg-slate-50 text-slate-500 text-[10px] uppercase font-black border-b">
                        <th class="col-data text-left">Data</th>
                        <th class="col-giorno text-center">Giorno</th>
                        <th class="col-ore text-center">Ord.</th>
                        <th class="col-ore text-center">Stra.</th>
                        <th class="col-ore text-center">Vgg.</th>
                        <th class="text-left">Dettaglio Codici</th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="text-sm"></tbody>
            </table>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-slate-900/60 hidden flex items-center justify-center p-4 z-50" onclick="closeModal()">
        <div class="modal-content bg-white rounded-3xl max-w-2xl w-full max-h-[90vh] overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
            <div id="modalHeader" class="p-6 border-b flex justify-between items-center bg-slate-50"></div>
            <div id="modalBody" class="p-6 overflow-y-auto max-h-[60vh] space-y-6 text-slate-800"></div>
            <div class="p-4 border-t bg-slate-50">
                <button onclick="closeModal()" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900 transition-all shadow-lg">Chiudi Dettaglio</button>
            </div>
        </div>
    </div>

    <script>
        let fullData = [];
        let slideshowTimer = null;

        const configTipi = {
            "MONTAGGIO": { bg: "bg-sky-100", border: "border-sky-200", icon: "üîß" },
            "ORDINARIA": { bg: "bg-white", border: "border-slate-200", icon: "üü¢" },
            "ALTRO": { bg: "bg-emerald-100", border: "border-emerald-200", icon: "üìå" },
            "MONT/STRA": { bg: "bg-blue-100", border: "border-blue-200", icon: "üõ†Ô∏è" },
            "REPERIBILIT√Ä": { bg: "bg-red-100", border: "border-red-200", icon: "üö®" },
            "STRAORDINARIO": { bg: "bg-orange-100", border: "border-orange-200", icon: "‚è±Ô∏è" }
        };

        const descCodici = {
            "072": "Assemblea", "073": "Sciopero", "075": "Ferie", "076": "Festivit√†", "077": "Malattia", 
            "078": "Infortunio", "079": "Donazione Sangue", "080": "Allattamento", "081": "Congedo Matr.",
            "082": "Permesso Retr.", "083": "Permesso NON Retr.", "084": "Legge 104", "085": "Elettorale",
            "086": "Lutto", "087": "Sindacale", "088": "Studio", "089": "Volontariato", 
            "090": "Malattia Figlio <3", "091": "Malattia Figlio >3", "092": "Corso Formazione"
        };

        const getFestivi = () => ["01-01", "06-01", "25-04", "01-05", "02-06", "15-08", "04-10", "01-11", "08-12", "25-12", "26-12"];
        const parseNum = (v) => v ? parseFloat(v.toString().replace(',', '.')) || 0 : 0;
        const formatVal = (v, fz) => (v === 0) ? (fz ? "0,00" : "") : v.toLocaleString('it-IT', {minimumFractionDigits: 2});

        document.getElementById('upload').addEventListener('change', (e) => {
            const reader = new FileReader();
            reader.onload = (evt) => {
                const wb = XLSX.read(evt.target.result, {type: 'array'});
                fullData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames.find(n => n.toLowerCase().includes("lavoro")) || wb.SheetNames[0]], {defval: ""});
                document.getElementById('filter-bar').classList.remove('hidden');
                document.getElementById('stats-panel').classList.remove('hidden');
                popolaTecnici();
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });

        function popolaTecnici() {
            const tecnici = [...new Set(fullData.map(d => d.tecnico))].filter(Boolean).sort();
            const sel = document.getElementById('selectTecnico');
            sel.innerHTML = '<option value="">-- Seleziona Tecnico --</option>';
            tecnici.forEach(t => sel.add(new Option(t, t)));
            [sel, document.getElementById('selectMese'), document.getElementById('selectAnno')].forEach(el => el.onchange = renderTable);
        }

        function toggleSlideshow(ms, btnId) {
            pauseSlideshow();
            document.getElementById(btnId).classList.add('btn-active');
            slideshowTimer = setInterval(() => {
                const sel = document.getElementById('selectTecnico');
                if (sel.options.length <= 1) return;
                let nextIndex = sel.selectedIndex + 1;
                if (nextIndex >= sel.options.length) nextIndex = 1; 
                sel.selectedIndex = nextIndex;
                renderTable();
            }, ms);
        }

        function pauseSlideshow() {
            clearInterval(slideshowTimer);
            slideshowTimer = null;
            document.getElementById('btnPlay').classList.remove('btn-active');
            document.getElementById('btnFast').classList.remove('btn-active');
        }

        function stopSlideshow() {
            pauseSlideshow();
            const sel = document.getElementById('selectTecnico');
            sel.selectedIndex = 1; 
            renderTable();
        }

        function renderTable() {
            const tec = document.getElementById('selectTecnico').value;
            const m = parseInt(document.getElementById('selectMese').value);
            const a = parseInt(document.getElementById('selectAnno').value);
            if (!tec) return;

            const festivi = getFestivi();
            const ultimoGiorno = new Date(a, m, 0).getDate();
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            let totLavorate = 0, totAssenze = 0, totStra = 0, totVgg = 0, totPreviste = 0;
            let dec = [{eff:0, pre:0}, {eff:0, pre:0}, {eff:0, pre:0}];

            const raggruppati = fullData.filter(d => String(d.tecnico) === tec && parseInt(d.mese) === m && parseInt(d.anno) === a)
                .reduce((acc, r) => {
                    const g = parseInt(r.giorno);
                    if (!acc[g]) acc[g] = { ord: 0, ass: 0, stra: 0, vgg: 0, desc: new Set(), list: [] };
                    const oreR = parseNum(r.ore_ord);
                    const codR = parseInt(r.codice);
                    if (codR >= 72 && codR <= 91) acc[g].ass += oreR;
                    else acc[g].ord += oreR;
                    acc[g].stra += parseNum(r.ore_stra);
                    acc[g].vgg += parseNum(r.ore_viaggio);
                    let cKey = codR.toString().padStart(3, '0');
                    if (descCodici[cKey]) acc[g].desc.add(descCodici[cKey] + ` (${cKey})`);
                    acc[g].list.push(r);
                    return acc;
                }, {});

            for (let i = 1; i <= ultimoGiorno; i++) {
                const dataC = new Date(a, m - 1, i);
                const gSett = dataC.getDay();
                const isF = festivi.includes(`${String(i).padStart(2, '0')}-${String(m).padStart(2, '0')}`);
                const day = raggruppati[i] || { ord: 0, ass: 0, stra: 0, vgg: 0, desc: new Set(), list: [] };

               // Se √® Sabato (6) o Domenica (0), le ore previste sono SEMPRE 0, anche se √® festivo.
// Altrimenti (Luned√¨-Venerd√¨), le ore previste sono 8.
let prevista = (gSett !== 0 && gSett !== 6) ? 8 : 0;
                totPreviste += prevista;
                totLavorate += day.ord;
                totAssenze += day.ass;
                totStra += day.stra;
                totVgg += day.vgg;

                const totGiornoPerDecade = day.ord + day.ass;
                let idx = i <= 10 ? 0 : (i <= 20 ? 1 : 2);
                dec[idx].eff += totGiornoPerDecade;
                dec[idx].pre += prevista;

                let rowClass = isF ? "bg-festivo" : (gSett === 0 ? "bg-domenica" : (gSett === 6 ? "bg-sabato" : ""));
                let ordStyle = (prevista > 0) ? (totGiornoPerDecade === 8 ? "text-ok" : "text-anomaly") : (totGiornoPerDecade > 0 ? "text-anomaly" : "");
                let fz = (prevista === 8 && totGiornoPerDecade === 0);

                const tr = document.createElement('tr');
                tr.className = `${rowClass} row-hover border-b transition-colors`;
                tr.onclick = () => openDayDetail(dataC.toLocaleDateString('it-IT'), day);
                tr.innerHTML = `
                    <td class="text-slate-400 font-medium">${dataC.toLocaleDateString('it-IT')}</td>
                    <td class="text-[10px] uppercase font-black text-slate-400 text-center">${dataC.toLocaleDateString('it-IT', {weekday: 'short'})}</td>
                    <td class="text-center ${ordStyle}">${formatVal(totGiornoPerDecade, fz)}</td>
                    <td class="text-center font-medium">${formatVal(day.stra)}</td>
                    <td class="text-center font-medium text-slate-500">${formatVal(day.vgg)}</td>
                    <td class="text-left text-blue-700 font-bold text-[11px]">${Array.from(day.desc).join(' / ')}</td>
                `;
                tbody.appendChild(tr);
            }

            document.getElementById('sumOrd').innerText = totLavorate.toFixed(2).replace('.',',');
            document.getElementById('sumAss').innerText = totAssenze.toFixed(2).replace('.',',');
            document.getElementById('sumStra').innerText = totStra.toFixed(2).replace('.',',');
            document.getElementById('sumVgg').innerText = totVgg.toFixed(2).replace('.',',');
            const totalEff = totLavorate + totAssenze;
            const ratioEl = document.getElementById('totalRatio');
            ratioEl.innerText = `${totalEff.toFixed(2).replace('.',',')} / ${totPreviste.toFixed(2).replace('.',',')}`;
            ratioEl.className = `text-sm font-black italic ${totalEff === totPreviste ? 'text-green-600' : 'text-red-600'}`;
            const ck = (d) => d.eff === d.pre ? "‚úîÔ∏è" : "‚ùå";
            document.getElementById('decadeStatus').innerHTML = `1Ô∏è‚É£${ck(dec[0])} 2Ô∏è‚É£${ck(dec[1])} 3Ô∏è‚É£${ck(dec[2])}`;
        }

        function openDayDetail(dateStr, data) {
            const header = document.getElementById('modalHeader');
            const body = document.getElementById('modalBody');
            const totalDay = data.ord + data.ass;
            
            header.innerHTML = `
                <div><h2 class="text-2xl font-black text-slate-800">${dateStr}</h2><p class="text-xs text-slate-500 uppercase font-bold tracking-widest">${document.getElementById('selectTecnico').value}</p></div>
                <div class="px-4 py-2 bg-slate-800 text-white rounded-2xl text-center shadow-lg"><p class="text-[10px] uppercase font-bold opacity-70 leading-none">Ore Giorno</p><p class="text-xl font-black">${totalDay.toFixed(2).replace('.',',')}</p></div>
            `;

            if (data.list.length === 0) {
                body.innerHTML = `<div class="text-center py-10 text-slate-400 italic">Nessun dato registrato.</div>`;
            } else {
                body.innerHTML = '';
                data.list.forEach((item, index) => {
                    const tipo = String(item.ch_rep || "").trim().toUpperCase();
                    const style = configTipi[tipo] || { bg: "bg-slate-50", border: "border-slate-200", icon: "üìÑ" };
                    const isAssenza = parseInt(item.codice) >= 72;

                    body.innerHTML += `
                        <div class="relative pl-10">
                            ${index < data.list.length - 1 ? '<div class="timeline-line"></div>' : ''}
                            <div class="absolute left-0 top-0 w-10 h-10 bg-white border-2 border-slate-200 rounded-full flex items-center justify-center z-10 shadow-sm">
                                <span class="text-lg">${style.icon}</span>
                            </div>
                            <div class="${isAssenza ? 'bg-blue-50 border-blue-200' : style.bg + ' ' + style.border} border-2 rounded-2xl p-5 shadow-sm transition-all">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-[9px] font-black uppercase px-2 py-0.5 rounded bg-white/50 border border-black/5">${tipo || 'GENERICO'}</span>
                                            <h3 class="font-black text-slate-800 leading-tight">${item.impianto || '---'}</h3>
                                        </div>
                                    <p class="text-xl text-slate-700 font-black mt-2 tracking-tight">
   üìç ${item.indirizzo || '---'}
</p>
                                    </div>
                                    <div class="text-right">
                                        <span class="px-2 py-1 bg-slate-900 text-white text-[9px] font-black rounded uppercase">Cod. ${item.codice}</span>
                                        <p class="text-sm font-black text-slate-700 mt-2">üïí ${item.inizio_int || '??'}-${item.fine_int || '??'}</p>
                                    </div>
                                </div>
                                <div class="bg-white/40 backdrop-blur-sm border border-black/5 p-3 rounded-xl mb-3">
                                    <p class="text-xs text-slate-700 leading-relaxed italic">"${item.note || 'Nessuna nota tecnica.'}"</p>
                               
<div class="flex gap-8 mt-4 border-t border-black/5 pt-4">
    <div class="flex flex-col">
        <span class="text-[10px] text-slate-400 font-extrabold uppercase tracking-tighter">ORDINARIE</span>
        <span class="text-3xl font-black text-slate-800 leading-none">${formatVal(parseNum(item.ore_ord), true)}</span>
    </div>
    <div class="flex flex-col">
        <span class="text-[10px] text-slate-400 font-extrabold uppercase tracking-tighter">STRAORD.</span>
        <span class="text-3xl font-black text-orange-500 leading-none">${formatVal(parseNum(item.ore_stra), true)}</span>
    </div>
    <div class="flex flex-col">
        <span class="text-[10px] text-slate-400 font-extrabold uppercase tracking-tighter">VIAGGIO</span>
        <span class="text-3xl font-black text-blue-600 leading-none">${formatVal(parseNum(item.ore_viaggio), true)}</span>
    </div>
</div>
                            </div>
                        </div>
                    `;
                });
            }
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

function exportToExcel() {
    const tec = document.getElementById('selectTecnico').value;
    if (!tec) {
        alert("Seleziona prima un tecnico!");
        return;
    }

    const mese = document.getElementById('selectMese').options[document.getElementById('selectMese').selectedIndex].text;
    const anno = document.getElementById('selectAnno').value;
    
    // Selezioniamo la tabella
    const table = document.querySelector("table");
    
    // Creiamo un nuovo foglio di lavoro partendo dalla tabella HTML
    const wb = XLSX.utils.table_to_book(table, { sheet: "Riepilogo" });
    
    // Generiamo il file Excel e forziamo il download
    const fileName = `Monitor_${tec}_${mese}_${anno}.xlsx`.replace(/\s+/g, '_');
    XLSX.writeFile(wb, fileName);
}
function exportToPDF() {
    const tec = document.getElementById('selectTecnico').value;
    if (!tec) {
        alert("Seleziona prima un tecnico!");
        return;
    }
    
    // Cambiamo temporaneamente il titolo della pagina per il nome del file
    const originalTitle = document.title;
    const mese = document.getElementById('selectMese').options[document.getElementById('selectMese').selectedIndex].text;
    document.title = `Report_Presenze_${tec}_${mese}_2025`;

    // Avviamo la stampa
    window.print();

    // Ripristiniamo il titolo originale
    document.title = originalTitle;
}

async function generaPDF() {
    const { jsPDF } = window.jspdf;
    const tec = document.getElementById('selectTecnico').value;
    const meseSelect = document.getElementById('selectMese');
    const meseTesto = meseSelect.options[meseSelect.selectedIndex].text;
    const anno = document.getElementById('selectAnno').value;
    
    if (!tec) { 
        alert("Seleziona un tecnico prima di esportare!"); 
        return; 
    }

    // 1. Data automatica per la consegna
    const dataOggi = new Date().toLocaleDateString('it-IT');

    // 2. Riferimento all'elemento originale
    const element = document.querySelector(".max-w-7xl");
    
    // 3. Creazione contenitore temporaneo per il PDF
    const tempDiv = document.createElement('div');
    tempDiv.id = "temp-pdf-container";
    tempDiv.style.width = "1050px"; // Larghezza ottimale per proporzione A4
    tempDiv.style.padding = "40px";
    tempDiv.style.background = "white";
    tempDiv.style.position = "absolute";
    tempDiv.style.left = "-9999px";
    tempDiv.style.fontFamily = "sans-serif";

    // 4. CSS per ridurre l'altezza delle righe (20% in meno circa)
    const styleFix = document.createElement('style');
    styleFix.innerHTML = `
        #temp-pdf-container table { width: 100% !important; border-collapse: collapse !important; }
        #temp-pdf-container td, #temp-pdf-container th { 
            padding-top: 5px !important; 
            padding-bottom: 5px !important; 
            line-height: 1.1 !important;
            height: auto !important;
        }
        #temp-pdf-container .row-hover:hover { filter: none !important; }
    `;
    tempDiv.appendChild(styleFix);

    // 5. Intestazione professionale (testo statico invece dei menu)
    const headerInfo = `
        <div style="margin-bottom: 30px; border-bottom: 3px solid #1e293b; padding-bottom: 15px;">
            <h1 style="font-size: 28px; font-weight: 900; color: #1e293b; margin: 0; text-transform: uppercase; italic">Monitor Presenze - Report Ufficiale</h1>
            <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                <div>
                    <p style="font-size: 10px; font-bold; color: #64748b; text-transform: uppercase; margin: 0;">Tecnico</p>
                    <p style="font-size: 18px; font-weight: 800; color: #0f172a; margin: 0;">${tec.toUpperCase()}</p>
                </div>
                <div style="text-align: right;">
                    <p style="font-size: 10px; font-bold; color: #64748b; text-transform: uppercase; margin: 0;">Periodo di Riferimento</p>
                    <p style="font-size: 18px; font-weight: 800; color: #0f172a; margin: 0;">${meseTesto} ${anno}</p>
                </div>
            </div>
        </div>
    `;

    // 6. Clonazione e pulizia della Dashboard
    const dashboardClone = element.cloneNode(true);
    // Rimuoviamo tutto ci√≤ che √® interattivo e non deve finire nel PDF
    const elementsToRemove = dashboardClone.querySelectorAll('#upload, .btn-ctrl, select, button, input, #filter-bar');
    elementsToRemove.forEach(el => el.remove());

    // 7. Blocco Firme e Data in fondo
    const footerSign = `
        <div style="margin-top: 60px; display: flex; justify-content: space-between; padding: 0 40px;">
            <div style="text-align: center;">
                <div style="border-top: 1px solid #334155; width: 220px; margin-bottom: 8px;"></div>
                <p style="font-size: 10px; font-weight: 800; text-transform: uppercase; color: #475569;">Firma del Tecnico</p>
            </div>
            <div style="text-align: right;">
                <p style="font-size: 14px; font-weight: 800; color: #1e293b; margin-bottom: 30px;">Data Generazione: ${dataOggi}</p>
                <div style="display: inline-block; text-align: center;">
                    <div style="border-top: 1px solid #334155; width: 220px; margin-bottom: 8px;"></div>
                    <p style="font-size: 10px; font-weight: 800; text-transform: uppercase; color: #475569;">Firma Direzione</p>
                </div>
            </div>
        </div>
    `;

    // 8. Assemblaggio finale del documento temporaneo
    tempDiv.innerHTML += headerInfo;
    tempDiv.appendChild(dashboardClone);
    tempDiv.innerHTML += footerSign;
    document.body.appendChild(tempDiv);

    // 9. Generazione Canvas e PDF
    try {
        const canvas = await html2canvas(tempDiv, {
            scale: 2,
            useCORS: true,
            backgroundColor: "#ffffff",
            logging: false
        });
        
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        
        // Calcolo dimensioni immagine per adattarsi alla larghezza A4 (con 10mm di margine per lato)
        const imgWidth = pdfWidth - 20; 
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        // Se il contenuto √® pi√π lungo dell'A4, creiamo un PDF con altezza dinamica per non tagliare il fondo
        if (imgHeight > (pdfHeight - 20)) {
            const dynamicPdf = new jsPDF('p', 'mm', [pdfWidth, imgHeight + 30]);
            dynamicPdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
            dynamicPdf.save(`Report_${tec.replace(/\s+/g, '_')}_${meseTesto}.pdf`);
        } else {
            pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
            pdf.save(`Report_${tec.replace(/\s+/g, '_')}_${meseTesto}.pdf`);
        }
    } catch (error) {
        console.error("Errore durante la generazione del PDF:", error);
        alert("Si √® verificato un errore durante la creazione del PDF.");
    } finally {
        // Pulizia: rimuoviamo il div temporaneo dal documento
        document.body.removeChild(tempDiv);
    }
}
    </script>
</body>
</html>